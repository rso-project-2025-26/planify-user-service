server:
    port: ${SERVER_PORT:8082}

spring:
    application:
        name: user-service

    datasource:
        url: ${DB_URL:jdbc:postgresql://localhost:5432/planify}
        username: ${DB_USERNAME:planify}
        password: ${DB_PASSWORD:planify}
        driver-class-name: org.postgresql.Driver
        hikari:
            maximum-pool-size: ${DB_POOL_SIZE:10}
            minimum-idle: ${DB_POOL_MIN_IDLE:5}
            connection-timeout: ${DB_CONN_TIMEOUT:30000}

    jpa:
        hibernate:
            ddl-auto: ${JPA_DDL_AUTO:validate}
        properties:
            hibernate:
                dialect: org.hibernate.dialect.PostgreSQLDialect
                default_schema: ${DB_SCHEMA:auth}
        show-sql: ${JPA_SHOW_SQL:false}

    security:
        oauth2:
            resourceserver:
                jwt:
                    issuer-uri: ${KEYCLOAK_ISSUER_URI:http://localhost:9080/realms/planify}
                    jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:http://localhost:9080/realms/planify/protocol/openid-connect/certs}

    kafka:
        bootstrap-servers: ${KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
        consumer:
            group-id: ${KAFKA_CONSUMER_GROUP:user-service}
            auto-offset-reset: ${KAFKA_AUTO_OFFSET_RESET:earliest}
        producer:
            key-serializer: org.apache.kafka.common.serialization.StringSerializer
            value-serializer: org.apache.kafka.common.serialization.StringSerializer

    flyway:
        schemas: ${DB_SCHEMA:auth}
        default-schema: ${DB_SCHEMA:auth}
        create-schemas: true
        enabled: ${FLYWAY_ENABLED:true}

keycloak:
    url: ${KEYCLOAK_URL:http://localhost:9080}
    realm: ${KEYCLOAK_REALM:planify}
    admin:
        username: ${KEYCLOAK_ADMIN_USERNAME:admin}
        password: ${KEYCLOAK_ADMIN_PASSWORD:admin}

management:
    endpoints:
        web:
            exposure:
                include: ${MANAGEMENT_ENDPOINTS_INCLUDE:health,info,metrics,prometheus}
    endpoint:
        health:
            show-details: when-authorized
            probes:
                enabled: true
    metrics:
        export:
            prometheus:
                enabled: true

springdoc:
    swagger-ui:
        path: /swagger-ui.html
        enabled: true
    api-docs:
        path: /api-docs
        enabled: true

logging:
    level:
        root: ${LOG_LEVEL_ROOT:INFO}
        com.planify: ${LOG_LEVEL_APP:DEBUG}
        org.springframework.web: ${LOG_LEVEL_SPRING_WEB:INFO}
        org.springframework.security: ${LOG_LEVEL_SPRING_SECURITY:INFO}
        org.hibernate.SQL: ${LOG_LEVEL_HIBERNATE_SQL:INFO}
        io.github.resilience4j: DEBUG
    pattern:
        console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"

planify:
    kafka:
        topic:
            join-request-sent: ${KAFKA_TOPIC_JOIN_REQUEST_SENT:user.join-request-sent}
            join-request-responded: ${KAFKA_TOPIC_JOIN_REQUEST_RESPONDED:user.join-request-responded}
            invitation-sent: ${KAFKA_TOPIC_INVITATION_SENT:user.invitation-sent}
            invitation-responded: ${KAFKA_TOPIC_INVITATIONS_RESPONDED:user.invitation-responded}
    retention:
        enabled: ${RETENTION_ENABLED:true}
        schedule: ${RETENTION_SCHEDULE:0 0 2 * * *}

# Resilience4j Configuration (keep as-is, these are framework defaults)
resilience4j:
    circuitbreaker:
        instances:
            keycloakService:
                registerHealthIndicator: true
                slidingWindowSize: 10
                minimumNumberOfCalls: 5
                permittedNumberOfCallsInHalfOpenState: 3
                automaticTransitionFromOpenToHalfOpenEnabled: true
                waitDurationInOpenState: 10s
                failureRateThreshold: 50
                eventConsumerBufferSize: 10
                recordExceptions:
                    - java.lang.Exception
                    - java.lang.RuntimeException
                    - org.springframework.web.client.HttpServerErrorException
                    - org.springframework.web.client.ResourceAccessException
                    - java.io.IOException
                    - java.util.concurrent.TimeoutException
            defaultCircuitBreaker:
                registerHealthIndicator: true
                slidingWindowSize: 100
                minimumNumberOfCalls: 10
                permittedNumberOfCallsInHalfOpenState: 3
                automaticTransitionFromOpenToHalfOpenEnabled: true
                waitDurationInOpenState: 5s
                failureRateThreshold: 50
                eventConsumerBufferSize: 10

    retry:
        instances:
            keycloakService:
                maxAttempts: 3
                waitDuration: 1s
                enableExponentialBackoff: true
                exponentialBackoffMultiplier: 2
                retryExceptions:
                    - java.lang.Exception
                    - java.lang.RuntimeException
                    - org.springframework.web.client.HttpServerErrorException
                    - org.springframework.web.client.ResourceAccessException
                    - java.io.IOException
            defaultRetry:
                maxAttempts: 3
                waitDuration: 500ms
                enableExponentialBackoff: true
                exponentialBackoffMultiplier: 2

    bulkhead:
        instances:
            keycloakService:
                maxConcurrentCalls: 10
                maxWaitDuration: 1s
            defaultBulkhead:
                maxConcurrentCalls: 25
                maxWaitDuration: 0

    ratelimiter:
        instances:
            keycloakService:
                limitForPeriod: 50
                limitRefreshPeriod: 1s
                timeoutDuration: 0
            defaultRateLimiter:
                limitForPeriod: 100
                limitRefreshPeriod: 1s
                timeoutDuration: 0

    timelimiter:
        instances:
            keycloakService:
                timeoutDuration: 5s
            defaultTimeLimiter:
                timeoutDuration: 3s